#!/bin/bash

# Check if the 'adb' command is available
if ! command -v adb &> /dev/null; then
    echo "Error: 'adb' command not found. Please make sure Android Debug Bridge is installed and in your PATH."
    exit 1
fi

# Function to start strace and monkey, then extract logFile
start_strace_monkey() {
    local package="$1"
    local apk_file="$2"
    local log_file="$3"

    # Install the APK file
    adb install "$apk_file"

    # Start the main activity of the application
    adb shell am start -n "$package/.MainActivity"

    # Get the process ID of the running app
    local pid=$(adb shell pidof "$package")

    if [ -n "$pid" ]; then
        # Start strace
        adb shell strace -p "$pid" -o "$log_file" -f -ttt &
        strace_pid=$!

        # Start adb monkey for 2 minutes
        adb shell monkey -p "$package" --throttle 200 --ignore-crashes --ignore-timeouts 120

        # Close the app
        adb shell am force-stop "$package"

        # Kill strace
        kill "$strace_pid"

        # Extract the logFile to local storage
        adb pull "$log_file" .
    else
        echo "Error: Could not retrieve the process ID for package $package."
    fi

    # Uninstall the APK file
    adb uninstall "$package"
}

# Directory containing APK files
dir="apks"

# Iterate through APK files in the directory
for apk_file in "$dir"/*.apk; do
    if [ -f "$apk_file" ]; then
        # Get the package name from the APK file
        package=$(aapt dump badging "$apk_file" | awk -F"'" '/package: name=/{print $2}')

        if [ -n "$package" ]; then
            log_file="strace_${package}.txt"
            start_strace_monkey "$package" "$apk_file" "$log_file"
        else
            echo "Error: Could not retrieve the package name from APK file $apk_file."
        fi
    fi
done

