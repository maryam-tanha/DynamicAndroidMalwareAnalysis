# apk-tracing
APK tracing to log sys-calls, api calls, network calls, etc

## Getting Started
1. Install all the required dependencies/libraries: `pip install -r requirements.txt`
2. Install `adb` and `aapt` using the [guide](https://www.xda-developers.com/install-adb-windows-macos-linux/)
3. Consider installing `genymotion` if you do not have a an rooted android device. Genymotion can be downloaded from [here](https://docs.genymotion.com/desktop/Get_started/Requirements/)

## How to add adb & aapt to the PATH
1. MacOS: 
    - Option 1: Already have Android SDK installed
        - On MacOS with default Android installation, the current `aapt` location is inside specific build-tools version. For build-tools 28.0.3, you will find it in the following path: `/Users/userName/Library/Android/sdk/build-tools/28.0.3`. To add it to the path, use: `export PATH=$PATH:/path/to/new/location`
    - Option2: Using Homebrew
        - `brew install android-platform-tools`
        - Start using adb, using: `adb devices`

2. Windows: Please visit [How-to-edit-add-path](https://www.nextofwindows.com/how-to-addedit-environment-variables-in-windows-7/) to see how to add path.
    - Paths should look like:
        - Platform Tools - `C:\Program Files\Android\sdk\platform-tools` 
        - Tools - `C:\Program Files\Android\sdk\tools`
    - aapt specifically is a Build Tool, so you'll want to add that directory as well. 
        - Build Tools - `C:\Program Files\Android\sdk\build-tools\18.1.0`

    > NOTE: For WSL users, please refer to `setup-scripts/wsl-setup.sh`

3. Linux: Please refer to the [guide](https://www.xda-developers.com/install-adb-windows-macos-linux/)

## Getting Syscalls
syscall-tracing script, inspired by [automated apk tracing, TwinDroid](https://github.com/RaphaelKhoury/automated-apk-tracing) performs the following tasks:

1. Installs an Android application from the input repository using ADB.
2. Retrieves the process ID (PID) of the zygote process.
3. Runs strace on the zygote process, capturing the system calls and their output into a file.
4. Starts an application specified by the package name and runs it for 20 seconds.
5. Retrieves the PID of the application process.
6. Simulates user interactions on the application using Monkey for 2000 seconds.
7. Stops the strace process and moves the strace output file to the output repository.

The script uses ADB commands to interact with the Android device/emulator and executes various operations such as installation, process management, and interaction simulation. The `get_package_name` function extracts the package name from the specified APK file using the `aapt` tool.

> To run the script: Please store the apk file in the apks folder and run: `python3 install apks/sample.apk` or `python install apks/sample.apk`

> Note that the script assumes the presence of the necessary tools (`adb` and `aapt`) in the system's PATH, and it expects the APK file to be specified with the correct path and file name. The output file and output repository paths are also defined within the script.

## Potential errors and how to solve
1. Have the `USB debugging mode on` if testing on an actual device.
2. May have to turn off if the `USB debugging mode` is already on and turn it back on when tryin to run `adb shell`.
3. Syscall tracing script may not be able to find `aapt` PATH which you will have to set manually.
4. If you are using WSL on windows machine, you would have to install adb and aapt on both host and guest machine, i.e. on Windows and Linux.