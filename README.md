# Dynamic Android Malware Analysis
APK tracing to log sys-calls, network calls, etc

## Getting Started
1. Install all the required dependencies/libraries: `pip install -r requirements.txt`
2. Install `adb` and `aapt` using the [guide](https://www.xda-developers.com/install-adb-windows-macos-linux/)
3. Consider installing `genymotion` if you do not have a an rooted android device. Genymotion can be downloaded from [here](https://docs.genymotion.com/desktop/Get_started/Requirements/)
4. Helpful guide to refer: [Sayfer - Termux](https://sayfer.io/blog/tracing-android-applications-with-termux-and-linux-utilities/) 
## How to add adb & aapt to the PATH
1. MacOS: 
    - Option 1: Already have Android SDK installed
        - On MacOS with default Android installation, the current `aapt` location is inside specific build-tools version. For build-tools 28.0.3, you will find it in the following path: `/Users/userName/Library/Android/sdk/build-tools/28.0.3`. To add it to the path, use: `export PATH=$PATH:/path/to/new/location`
    - Option2: Using Homebrew
        - `brew install android-platform-tools`
        - Start using adb, using: `adb devices`

2. Windows: Please visit [How-to-edit-add-path](https://www.nextofwindows.com/how-to-addedit-environment-variables-in-windows-7/) to see how to add path.
    - Paths should look like:
        - Platform Tools - `C:\Program Files\Android\sdk\platform-tools` 
        - Tools - `C:\Program Files\Android\sdk\tools`
    - aapt specifically is a Build Tool, so you'll want to add that directory as well. 
        - Build Tools - `C:\Program Files\Android\sdk\build-tools\18.1.0`

    > NOTE: For WSL users, please refer to `setup-scripts/wsl-setup.sh`

3. Linux: Please refer to the [guide](https://www.xda-developers.com/install-adb-windows-macos-linux/)

## Getting Syscalls
syscall-tracing python script, inspired by [automated apk tracing, TwinDroid](https://github.com/RaphaelKhoury/automated-apk-tracing) performs the following tasks:

    1. Installs an Android application from the input repository using ADB.
    2. Retrieves the process ID (PID) of the zygote process.
    3. Runs strace on the zygote process, capturing the system calls and their output into a file.
    4. Starts an application specified by the package name and runs it for 20 seconds.
    5. Retrieves the PID of the application process.
    6. Simulates user interactions on the application using Monkey for 2000 seconds.
    7. Stops the strace process and moves the strace output file to the output repository.

#### Pseudocode - system call trace
```js
syscallTrace(dir)
    open the android device
    using adb #Command shell utility in Android
    connect to the android device
    for each apk ﬁle in dir
        using aapt
            pkgName #get package name from apk ﬁle
        using adb
            install the apk ﬁle into device
            start the main activity of the application
            using package name 
                pid #process id of the running app
                if pid != null
                    apkFile #start strace(pid)
                    start adb monkey(package) for 2 mins
                        close the app
                        kill(strace)
                        extract logFile to local storage
                uninstall the apk
                
```

The script uses ADB commands to interact with the Android device/emulator and executes various operations such as installation, process management, and interaction simulation. The `get_package_name` function extracts the package name from the specified APK file using the `aapt` tool.

> To run the script: Please store the apk file in the apks folder and run: `python3 syscall-tracing.py apks/sample.apk` or `python syscall-tracing apks/sample.apk`

> Note that the script assumes the presence of the necessary tools (`adb` and `aapt`) in the system's PATH, and it expects the APK file to be specified with the correct path and file name. The output file and output repository paths are also defined within the script.

## Getting network calls
This Python script automates the process of running an APK on an Android device, capturing the network traffic during the monkey enabled testing of the apk file.

### Prerequisites
- Ensure you have the Android SDK (ADB) installed on your computer and your Android device connected with ADB debugging enabled.
- You must have `openssl` installed on your system to generate a self-signed certificate.
- The script expects a `tcpdump` executable (named `tcpdump`) located in the `./libs/` directory within the script's folder. Make sure you have the appropriate `tcpdump` executable for your device architecture.
> Note download latest tcpdump from [android tcpdump](https://www.androidtcpdump.com/android-tcpdump/downloads) and store it in `libs` directory depending on when you are looking at this repo.

The script will perform the following steps:

    1. Generate a self-signed certificate.
    2. Write the certificate to a PEM file and push it to the device.
    3. Setup tcpdump on the device.
    4. Install the APK on the device and run it with monkey.
    5. Start tcpdump to capture network traffic.
    6. Pull the tcpdump capture file from the device to your local machine.

#### Pseudocode - network call trace
```js
NetworkCallTrace():
    If there are insufficient command-line arguments:
        Display usage instructions and exit

    Parse command-line arguments to determine APK path and package name

    # Generate a self-signed certificate
    Execute the command to generate a self-signed certificate
    Execute the command to hash the certificate
    Create a PEM file and write the certificate into it
    Export additional certificate information to the PEM file

    # Push the certificate to the device's trusted certificates store
    Execute the necessary commands to push the certificate to the device's trusted certificates store

    # Set up network traffic capture on the device
    Execute the necessary commands to set up network traffic capture on the device

    # Install and run the APK on the device, simulating user interactions
    Execute the command to install the specified APK on the device
    Start the APK's main activity using the package name
    Simulate user interactions with the APK using Monkey

    # Start capturing network traffic on the device
    Execute the necessary commands to start capturing network traffic on the device

    # Retrieve and store the captured network traffic data
    Execute the necessary commands to retrieve and store the captured network traffic data

```

> To run the script: Please store the apk file in the apks folder and run: `python3 network-tracing.py apks/sample.apk` or `python network-tracing.py apks/sample.apk`

The output of running this script would be stored in `network-calls` directory with the name of the file being `<package_name>_dump.pcap`

## Run python scripts in a batch
To execute `sycall-tracing.py` or `network-tracing.py` to collect syscalls or network calls for multiple apks use `batch_trace_python.sh`. 

## Getting dumpsys data (cpu info, memory usage, battery usage)
This Python script allows to collect various system information from an Android device using the dumpsys command. It runs multiple dumpsys commands in parallel and saves their output to separate text files for analysis.

### Prerequisites
- Python 3.x
- Android Debug Bridge (ADB) installed and configured
- Android device connected to your computer via USB with USB debugging enabled

> To run the script: `python3 cpuinfo-collector.py` or `python cpuinfo-collector.py`

The output of running this script would be stored in various text files in the root directory. 
The file names are: `activity_dump.txt, window_dump.txt, meminfo_dump.txt, package_dump.txt, batteryinfo_dump.txt`.

## Extracting features from strace logs
This script is designed to process a strace log files and extract syscall information from them. It then creates individual CSV files, each containing the syscall information of one input log file. The script follows these steps:
    1. Accepts a single command-line argument: the path to the folder containing the `.txt` log files.
    2. Defines a function safe_open_w to safely create and open files for writing while ensuring the necessary directory structure exists.
    3. Uses regular expressions to match and extract syscall information from each log file.
    4. Processes each log file in the specified folder.

    Extracted Features are:
        1. Syscall Name
        2. Syscall Frequency
        3. Syscall Parameters Used
        4. Parameters Values Frequency

> To run the script: Please make sure your strace files are stored as `.txt` in the `logs/strace` directory and run: `python3 extract-features-syscall.py logs/strace` or `python extract-features-syscall.py logs/strace`

The output of running this script would be stored in `features/syscall-info` directory with the name of the file being `<strace-filename>.csv`


## Potential errors and how to solve
1. Have the `USB debugging mode on` if testing on an actual device.
2. May have to turn off if the `USB debugging mode` is already on and turn it back on when tryin to run `adb shell`.
3. Syscall tracing script may not be able to find `aapt` PATH which you will have to set manually.
4. If you are using WSL on windows machine, you would have to install adb and aapt on both host and guest machine, i.e. on Windows and Linux.
5. Even after remounting, adb might not let you push the certificate to the `cacerts`, try `adb mount -o remount,rw '/system'`


